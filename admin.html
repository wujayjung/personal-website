<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin</title>
  <script>document.write('<link rel="stylesheet" href="style.css?v=' + Date.now() + '">');</script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">

    <div class="admin-header">
      <a href="index.html">← back to site</a>
      <h1>Admin</h1>
      <button class="btn btn-ghost" id="logoutBtn" style="display:none" onclick="doLogout()">Sign out</button>
    </div>

    <!-- Login screen -->
    <div id="loginScreen" style="display:none">
      <form id="loginForm" novalidate>
        <div class="form-group">
          <label class="form-label" for="loginEmail">Email</label>
          <input type="email" id="loginEmail" placeholder="you@example.com" autocomplete="email">
        </div>
        <div class="form-group">
          <label class="form-label" for="loginPassword">Password</label>
          <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password">
        </div>
        <button type="submit" class="btn">Sign in</button>
        <p class="form-status" id="loginStatus"></p>
      </form>
    </div>

    <!-- Admin content (shown after login) -->
    <div id="adminContent" style="display:none">

      <form id="postForm" novalidate>

        <!-- Title -->
        <div class="form-group">
          <label class="form-label" for="postTitle">Title (optional)</label>
          <input type="text" id="postTitle" placeholder="Give this post a title...">
        </div>

        <!-- Tags -->
        <div class="form-group">
          <label class="form-label" for="postTags">Tags (optional, comma-separated)</label>
          <input type="text" id="postTags" placeholder="startup, notes, reading">
        </div>

        <!-- Private toggle -->
        <div class="form-group-inline">
          <label class="form-label" for="postPrivate">
            <input type="checkbox" id="postPrivate">
            Private — only visible when you're logged in
          </label>
        </div>

        <!-- Block editor -->
        <div class="block-editor" id="blockEditor"></div>

        <!-- Add block toolbar -->
        <div class="block-add-toolbar">
          <span class="block-add-label">Add</span>
          <button type="button" class="block-add-btn" onclick="addBlock('text')">Text</button>
          <button type="button" class="block-add-btn" onclick="addBlock('quote')">Quote</button>
          <button type="button" class="block-add-btn" onclick="addBlock('link')">Link</button>
          <button type="button" class="block-add-btn" onclick="addBlock('image')">Image</button>
        </div>

        <div style="display:flex;gap:10px;align-items:center">
          <button type="submit" class="btn" id="submitBtn">Post</button>
          <button type="button" class="btn btn-ghost" id="cancelBtn" style="display:none" onclick="cancelEdit()">Cancel</button>
        </div>
        <p class="form-status" id="formStatus"></p>

      </form>

      <!-- Existing posts -->
      <div class="post-list" id="postList" style="display:none">
        <p class="post-list-header" id="postListHeader"></p>
        <div id="postItems"></div>
      </div>

      <!-- Writing ideas -->
      <div class="ideas-section">
        <p class="post-list-header">Writing ideas</p>
        <form id="ideaForm" novalidate>
          <div class="idea-input-row">
            <input type="text" id="ideaInput" placeholder="Something to write about...">
            <button type="submit" class="btn btn-ghost">Add</button>
          </div>
        </form>
        <div id="ideaItems"></div>
      </div>

    </div>

  </div>

  <script>
    const SUPABASE_URL = 'https://zxdqlfusqmhdufsdyhzw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4ZHFsZnVzcW1oZHVmc2R5aHp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MDUyMzksImV4cCI6MjA4NzM4MTIzOX0.qItSdfE15aQcG4D6gYfoJq_2-tfHqd7ltVjV_V7qkZw';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let posts = [];
    let editingId = null;
    let ideas = [];

    // ── Boot ──

    async function boot() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) {
        document.getElementById('loginScreen').style.display = '';
        return;
      }
      await showAdmin();
    }

    async function showAdmin() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('adminContent').style.display = '';
      document.getElementById('logoutBtn').style.display = '';
      await loadPostsFromDB();
      await loadIdeasFromDB();
      addBlock('text');
      renderPostList();
      renderIdeas();

      const flash = sessionStorage.getItem('flash');
      if (flash) {
        sessionStorage.removeItem('flash');
        setStatus(flash);
        setTimeout(function () { setStatus(''); }, 2500);
      }
    }

    async function loadPostsFromDB() {
      const { data, error } = await sb.from('posts').select('*').order('date', { ascending: false });
      if (error) { console.error(error); return; }
      posts = data || [];
    }

    // ── Login / Logout ──

    document.getElementById('loginForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const status = document.getElementById('loginStatus');
      status.textContent = 'Signing in…';
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if (error) { status.textContent = error.message; return; }
      status.textContent = '';
      await showAdmin();
    });

    async function doLogout() {
      await sb.auth.signOut();
      posts = [];
      document.getElementById('loginScreen').style.display = '';
      document.getElementById('adminContent').style.display = 'none';
      document.getElementById('logoutBtn').style.display = 'none';
    }

    // ── Block creation ──

    function addBlock(type, data) {
      data = data || {};
      const id = 'b_' + Date.now() + '_' + Math.random().toString(36).slice(2, 6);
      const el = createBlockEl(id, type, data);
      document.getElementById('blockEditor').appendChild(el);
      // Focus first input
      const first = el.querySelector('textarea, input[type="text"], input[type="url"]');
      if (first) first.focus();
    }

    function createBlockEl(id, type, data) {
      const div = document.createElement('div');
      div.className = 'block';
      div.dataset.id = id;
      div.dataset.type = type;

      const labels = { text: 'Text', quote: 'Quote', link: 'Link', image: 'Image' };

      // Header
      const header = document.createElement('div');
      header.className = 'block-header';
      header.innerHTML =
        '<span class="block-type-label">' + labels[type] + '</span>' +
        '<div class="block-actions">' +
          '<button type="button" class="block-action-btn" title="Move up" onclick="moveBlock(\'' + id + '\',\'up\')">↑</button>' +
          '<button type="button" class="block-action-btn" title="Move down" onclick="moveBlock(\'' + id + '\',\'down\')">↓</button>' +
          '<button type="button" class="block-action-btn delete" title="Delete" onclick="deleteBlock(\'' + id + '\')">×</button>' +
        '</div>';
      div.appendChild(header);

      // Body
      if (type === 'text') {
        const toolbar = document.createElement('div');
        toolbar.className = 'text-format-toolbar';
        toolbar.innerHTML =
          '<button type="button" class="fmt-btn" data-fmt="bullet" title="Bullet list" onmousedown="event.preventDefault()" onclick="applyListFormat(\'' + id + '\', \'bullet\')">•</button>' +
          '<button type="button" class="fmt-btn" data-fmt="dash" title="Dash list" onmousedown="event.preventDefault()" onclick="applyListFormat(\'' + id + '\', \'dash\')">—</button>' +
          '<button type="button" class="fmt-btn" data-fmt="number" title="Numbered list" onmousedown="event.preventDefault()" onclick="applyListFormat(\'' + id + '\', \'number\')">1.</button>';
        div.appendChild(toolbar);

        const ce = document.createElement('div');
        ce.className = 'block-content';
        ce.contentEditable = 'true';
        ce.setAttribute('data-placeholder', 'Write something...');
        ce.innerHTML = data.content ? deserializeToHTML(data.content) : '<p><br></p>';
        ce.addEventListener('keydown', function(e) { handleCEKeydown(e, id); });
        ce.addEventListener('keyup',  function()  { updateFormatButtons(ce, id); });
        ce.addEventListener('click',  function()  { updateFormatButtons(ce, id); });
        ce.addEventListener('paste', function(e) {
          e.preventDefault();
          var text = (e.clipboardData || window.clipboardData).getData('text/plain');
          if (text) document.execCommand('insertText', false, text);
        });
        div.appendChild(ce);

      } else if (type === 'quote') {
        const ta = inputEl('textarea', 'quote-content', 'The quote...');
        ta.style.minHeight = '90px';
        ta.value = data.content || '';
        div.appendChild(ta);

        const row = document.createElement('div');
        row.className = 'block-row';
        const attr = inputEl('input', 'quote-attr', 'Attribution (optional)');
        attr.value = data.attribution || '';
        const url = inputEl('input', 'quote-url', 'Source URL (optional)');
        url.type = 'url';
        url.value = data.url || '';
        row.appendChild(attr);
        row.appendChild(url);
        div.appendChild(row);

      } else if (type === 'link') {
        const url = inputEl('input', 'link-url', 'https://...');
        url.type = 'url';
        url.value = data.url || '';
        div.appendChild(url);

        const title = inputEl('input', 'link-title', 'Link title (optional)');
        title.value = data.title || '';
        div.appendChild(title);

        const desc = inputEl('textarea', 'link-desc', 'Description (optional)');
        desc.style.minHeight = '70px';
        desc.value = data.description || '';
        div.appendChild(desc);

      } else if (type === 'image') {
        if (data.src) {
          div.dataset.src = data.src;
          const img = document.createElement('img');
          img.className = 'image-preview-thumb';
          img.src = data.src;
          div.appendChild(img);
        } else {
          const zone = document.createElement('div');
          zone.className = 'image-drop-zone';
          zone.textContent = 'Click to upload · or paste an image anywhere';
          zone.addEventListener('click', function () {
            fileInput.click();
          });
          div.appendChild(zone);

          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.accept = 'image/*';
          fileInput.style.display = 'none';
          fileInput.addEventListener('change', function () {
            if (this.files[0]) readImageFile(this.files[0], id);
          });
          div.appendChild(fileInput);
        }

        const caption = inputEl('input', 'image-caption', 'Caption (optional)');
        caption.value = data.caption || '';
        div.appendChild(caption);
      }

      return div;
    }

    // ── Block helpers ──

    function inputEl(tag, cls, placeholder) {
      const el = document.createElement(tag === 'textarea' ? 'textarea' : 'input');
      if (tag === 'input') el.type = 'text';
      el.className = cls;
      el.placeholder = placeholder;
      return el;
    }

    function moveBlock(id, direction) {
      const el = document.querySelector('[data-id="' + id + '"]');
      if (!el) return;
      const editor = document.getElementById('blockEditor');
      if (direction === 'up' && el.previousElementSibling) {
        editor.insertBefore(el, el.previousElementSibling);
      } else if (direction === 'down' && el.nextElementSibling) {
        el.nextElementSibling.insertAdjacentElement('afterend', el);
      }
    }

    function deleteBlock(id) {
      document.querySelector('[data-id="' + id + '"]')?.remove();
    }

    // ── Image handling ──

    function readImageFile(file, blockId) {
      const reader = new FileReader();
      reader.onload = function (e) { setImageSrc(blockId, e.target.result); };
      reader.readAsDataURL(file);
    }

    function setImageSrc(blockId, src) {
      const el = document.querySelector('[data-id="' + blockId + '"]');
      if (!el) return;
      el.dataset.src = src;

      // Swap drop zone for preview
      const zone = el.querySelector('.image-drop-zone');
      const fileInput = el.querySelector('input[type="file"]');
      if (zone) {
        const img = document.createElement('img');
        img.className = 'image-preview-thumb';
        img.src = src;
        zone.replaceWith(img);
      }
      if (fileInput) fileInput.remove();
    }

    // Paste image anywhere on the page → create a new image block
    document.addEventListener('paste', function (e) {
      const items = Array.from(e.clipboardData ? e.clipboardData.items : []);
      const imgItem = items.find(function (i) { return i.type.startsWith('image/'); });
      if (!imgItem) return;
      e.preventDefault();
      const file = imgItem.getAsFile();
      const id = 'b_' + Date.now() + '_paste';
      const el = createBlockEl(id, 'image', {});
      document.getElementById('blockEditor').appendChild(el);
      readImageFile(file, id);
    });

    // ── Collect blocks from DOM ──

    function collectBlocks() {
      const result = [];
      document.querySelectorAll('#blockEditor .block').forEach(function (el) {
        const type = el.dataset.type;
        const id = el.dataset.id;

        if (type === 'text') {
          const elem = el.querySelector('.block-content');
          if (!elem) return;
          const content = elem.getAttribute('contenteditable') === 'true'
            ? serializeFromCE(elem).trim()
            : (elem.value || '').trim();
          if (content) result.push({ id: id, type: type, content: content });

        } else if (type === 'quote') {
          const content = (el.querySelector('.quote-content') || {}).value;
          const attribution = (el.querySelector('.quote-attr') || {}).value;
          const url = (el.querySelector('.quote-url') || {}).value;
          if (content && content.trim()) {
            const b = { id: id, type: type, content: content.trim() };
            if (attribution && attribution.trim()) b.attribution = attribution.trim();
            if (url && url.trim()) b.url = url.trim();
            result.push(b);
          }

        } else if (type === 'link') {
          const url = (el.querySelector('.link-url') || {}).value;
          const title = (el.querySelector('.link-title') || {}).value;
          const description = (el.querySelector('.link-desc') || {}).value;
          if (url && url.trim()) {
            const b = { id: id, type: type, url: url.trim() };
            if (title && title.trim()) b.title = title.trim();
            if (description && description.trim()) b.description = description.trim();
            result.push(b);
          }

        } else if (type === 'image') {
          const src = el.dataset.src;
          const caption = (el.querySelector('.image-caption') || {}).value;
          if (src) {
            const b = { id: id, type: type, src: src };
            if (caption && caption.trim()) b.caption = caption.trim();
            result.push(b);
          }
        }
      });
      return result;
    }

    // ── Submit ──

    document.getElementById('postForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const title = document.getElementById('postTitle').value.trim();
      const blocks = collectBlocks();
      const tags = parseTags(document.getElementById('postTags').value);
      const isPrivate = document.getElementById('postPrivate').checked;

      if (!blocks.length) {
        setStatus('Add some content first.');
        return;
      }

      if (editingId) {
        const { error } = await sb.from('posts').update({
          title: title || null,
          blocks: blocks,
          tags: tags,
          is_private: isPrivate,
        }).eq('id', editingId);
        if (error) { setStatus('Error: ' + error.message); return; }
        sessionStorage.setItem('flash', 'Updated.');
        window.location.reload();
        return;
      }

      const now = new Date();
      const date = now.getFullYear() + '-' +
        String(now.getMonth() + 1).padStart(2, '0') + '-' +
        String(now.getDate()).padStart(2, '0');

      const post = { id: Date.now().toString(), date: date, blocks: blocks, tags: tags, is_private: isPrivate };
      if (title) post.title = title;

      const { error } = await sb.from('posts').insert(post);
      if (error) { setStatus('Error: ' + error.message); return; }

      await loadPostsFromDB();
      resetForm();
      setStatus('Posted.');
      setTimeout(function () { setStatus(''); }, 2000);
      renderPostList();
    });

    // ── Edit post ──

    function editPost(id) {
      const post = posts.find(function (p) { return p.id === id; });
      if (!post) return;

      editingId = id;

      // Populate title
      document.getElementById('postTitle').value = post.title || '';

      // Populate tags
      document.getElementById('postTags').value = (post.tags || []).join(', ');

      // Populate private toggle
      document.getElementById('postPrivate').checked = !!post.is_private;

      // Populate blocks
      document.getElementById('blockEditor').innerHTML = '';
      (post.blocks || []).forEach(function (block) {
        addBlock(block.type, block);
      });

      // Update UI
      document.getElementById('submitBtn').textContent = 'Update';
      document.getElementById('cancelBtn').style.display = '';

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function cancelEdit() {
      resetForm();
      setStatus('');
    }

    function resetForm() {
      editingId = null;
      document.getElementById('postTitle').value = '';
      document.getElementById('postTags').value = '';
      document.getElementById('postPrivate').checked = false;
      document.getElementById('blockEditor').innerHTML = '';
      document.getElementById('submitBtn').textContent = 'Post';
      document.getElementById('cancelBtn').style.display = 'none';
      addBlock('text');
    }

    // ── Delete post ──

    async function deletePost(id) {
      if (!confirm('Delete this post?')) return;
      const { error } = await sb.from('posts').delete().eq('id', id);
      if (error) { alert('Error: ' + error.message); return; }
      posts = posts.filter(function (p) { return p.id !== id; });
      renderPostList();
    }

    // ── Render post list ──

    function renderPostList() {
      const list = document.getElementById('postList');
      const items = document.getElementById('postItems');
      const header = document.getElementById('postListHeader');

      if (!posts.length) { list.style.display = 'none'; return; }

      list.style.display = 'block';
      header.textContent = posts.length + ' post' + (posts.length !== 1 ? 's' : '');

      const sorted = posts.slice().sort(function (a, b) { return new Date(b.date) - new Date(a.date); });

      items.innerHTML = sorted.map(function (p) {
        // Preview: title or first block content
        let preview = p.title || '';
        if (!preview && p.blocks && p.blocks.length) {
          const first = p.blocks.find(function (b) { return b.content || b.url || b.src; });
          if (first) preview = first.content || first.url || '[image]';
        }
        if (preview.length > 70) preview = preview.slice(0, 70) + '…';

        const parts = p.date.split('-').map(Number);
        const dateStr = new Date(parts[0], parts[1] - 1, parts[2]).toLocaleDateString('en-US', {
          month: 'short', day: 'numeric', year: 'numeric'
        });

        const tagsStr = (p.tags && p.tags.length) ? p.tags.map(function(t) { return '#' + t; }).join(' ') : '';
        const privateBadge = p.is_private ? '<span class="post-item-private">private</span>' : '';

        return '<div class="post-item">' +
          '<span class="post-item-content">' + escHtml(preview) + '</span>' +
          (tagsStr ? '<span class="post-item-tags">' + escHtml(tagsStr) + '</span>' : '') +
          privateBadge +
          '<span class="post-item-meta">' + dateStr + '</span>' +
          '<button class="post-item-delete" onclick="editPost(\'' + p.id + '\')">edit</button>' +
          '<button class="post-item-delete" onclick="deletePost(\'' + p.id + '\')">delete</button>' +
          '</div>';
      }).join('');
    }

    // ── List formatting (contenteditable) ──

    function deserializeToHTML(text) {
      if (!text) return '<p><br></p>';
      var lines = text.split('\n');
      var segs = [], textBuf = [], i = 0;

      function getInfo(line) {
        var t = line.trimStart();
        if (!t) return null;
        var indent = Math.floor((line.length - t.length) / 2);
        if (t.startsWith('• ')) return { type: 'bullet', content: t.slice(2), indent: indent };
        if (t.startsWith('- ') && t.length > 2) return { type: 'dash', content: t.slice(2), indent: indent };
        var m = t.match(/^\d+\. ([\s\S]*)/);
        if (m) return { type: 'number', content: m[1], indent: indent };
        return null;
      }

      while (i < lines.length) {
        var line = lines[i];
        var info = getInfo(line);
        if (info) {
          if (textBuf.length) { segs.push({ type: 'text', lines: textBuf.slice() }); textBuf = []; }
          var items = [];
          while (i < lines.length) {
            var li = getInfo(lines[i]);
            if (li) { items.push(li); i++; }
            else if (!lines[i].trim()) { i++; break; }
            else break;
          }
          if (items.length) segs.push({ type: 'list', items: items });
        } else if (!line.trim()) {
          if (textBuf.length) { segs.push({ type: 'text', lines: textBuf.slice() }); textBuf = []; }
          i++;
        } else {
          textBuf.push(line); i++;
        }
      }
      if (textBuf.length) segs.push({ type: 'text', lines: textBuf });

      return segs.map(function(seg) {
        if (seg.type === 'text') {
          return seg.lines.map(function(l) { return '<p>' + escHtml(l) + '</p>'; }).join('');
        }
        var min = Math.min.apply(null, seg.items.map(function(it) { return it.indent; }));
        var norm = seg.items.map(function(it) { return Object.assign({}, it, { indent: it.indent - min }); });
        return buildHTMLList(norm, 0);
      }).join('');
    }

    function buildHTMLList(items, base) {
      var first = items.find(function(it) { return it.indent === base; });
      if (!first) return '';
      var tag = first.type === 'number' ? 'ol' : 'ul';
      var cls = first.type === 'dash' ? ' class="list-dash"' : '';
      var html = '<' + tag + cls + '>';
      var j = 0;
      while (j < items.length) {
        var item = items[j];
        if (item.indent !== base) { j++; continue; }
        var nested = []; var k = j + 1;
        while (k < items.length && items[k].indent > base) { nested.push(items[k]); k++; }
        html += '<li>' + escHtml(item.content) + (nested.length ? buildHTMLList(nested, base + 1) : '') + '</li>';
        j = k;
      }
      return html + '</' + tag + '>';
    }

    function serializeFromCE(ce) {
      function serNode(node, indent) {
        if (node.nodeType === 3) return node.textContent;
        if (node.nodeName === 'BR') return node.nextSibling ? '\n' : '';
        var name = node.nodeName;
        if (name === 'P' || name === 'DIV') {
          var content = '';
          Array.from(node.childNodes).forEach(function(c) { content += serNode(c, ''); });
          return content.replace(/\n$/, '') + '\n';
        }
        if (name === 'UL' || name === 'OL') {
          var isDash = node.classList.contains('list-dash');
          var isOL = name === 'OL';
          var num = 1, result = '';
          Array.from(node.children).forEach(function(li) {
            if (li.nodeName !== 'LI') return;
            var liText = '', nested = '';
            Array.from(li.childNodes).forEach(function(c) {
              if (c.nodeName === 'UL' || c.nodeName === 'OL') {
                nested += serNode(c, indent + '  ');
              } else {
                liText += serNode(c, '');
              }
            });
            var pfx = isDash ? indent + '- ' : isOL ? indent + (num++) + '. ' : indent + '• ';
            result += pfx + liText.trim() + '\n' + nested;
          });
          return result;
        }
        var r = '';
        Array.from(node.childNodes).forEach(function(c) { r += serNode(c, indent); });
        return r;
      }
      var text = '';
      Array.from(ce.childNodes).forEach(function(node) { text += serNode(node, ''); });
      return text.replace(/\n+$/, '');
    }

    function makeList(format) {
      var list = document.createElement(format === 'number' ? 'ol' : 'ul');
      if (format === 'dash') list.className = 'list-dash';
      return list;
    }

    function setCursorEnd(el) {
      var range = document.createRange();
      var sel = window.getSelection();
      range.selectNodeContents(el);
      range.collapse(false);
      sel.removeAllRanges();
      sel.addRange(range);
    }

    function applyListFormat(blockId, format) {
      var block = document.querySelector('[data-id="' + blockId + '"]');
      var ce = block.querySelector('.block-content[contenteditable]');
      if (!ce) return;
      ce.focus();
      var sel = window.getSelection();
      if (!sel || !sel.rangeCount) return;

      var anchor = sel.anchorNode;
      var container = anchor ? (anchor.nodeType === 3 ? anchor.parentElement : anchor) : ce;
      var li = container.closest && container.closest('li');

      if (li) {
        var parentList = li.parentElement;
        var curFmt = parentList.nodeName === 'OL' ? 'number'
          : parentList.classList.contains('list-dash') ? 'dash' : 'bullet';

        if (curFmt === format) {
          // Toggle off: convert li to <p>
          var p = document.createElement('p');
          var frag = document.createDocumentFragment();
          Array.from(li.childNodes).forEach(function(c) {
            if (c.nodeName !== 'UL' && c.nodeName !== 'OL') frag.appendChild(c.cloneNode(true));
          });
          p.appendChild(frag);
          if (!p.textContent && !p.querySelector('br')) p.innerHTML = '<br>';
          parentList.parentNode.insertBefore(p, parentList.nextSibling);
          li.remove();
          if (!parentList.children.length) parentList.remove();
          setCursorEnd(p);
        } else {
          // Change list type
          var newList = makeList(format);
          Array.from(parentList.children).forEach(function(item) {
            newList.appendChild(item.cloneNode(true));
          });
          parentList.parentNode.replaceChild(newList, parentList);
          var firstLi = newList.querySelector('li');
          if (firstLi) setCursorEnd(firstLi);
        }
      } else {
        // Find direct child of ce containing cursor
        var node = container;
        while (node && node.parentElement !== ce) node = node.parentElement;
        var newList2 = makeList(format);
        var newLi = document.createElement('li');
        if (node && node !== ce) {
          while (node.firstChild) newLi.appendChild(node.firstChild);
          if (!newLi.firstChild) newLi.innerHTML = '<br>';
          newList2.appendChild(newLi);
          ce.replaceChild(newList2, node);
        } else {
          newLi.innerHTML = '<br>';
          newList2.appendChild(newLi);
          ce.appendChild(newList2);
        }
        setCursorEnd(newLi);
      }
      updateFormatButtons(ce, blockId);
    }

    function handleCEKeydown(e, blockId) {
      var ce = e.currentTarget;
      var sel = window.getSelection();
      if (!sel || !sel.rangeCount) return;
      var anchor = sel.anchorNode;
      var container = anchor ? (anchor.nodeType === 3 ? anchor.parentElement : anchor) : null;
      var li = container && container.closest && container.closest('li');

      if (e.key === 'Enter' && li && !e.shiftKey) {
        if (!li.textContent.trim()) {
          e.preventDefault();
          var parentList = li.parentElement;
          var p = document.createElement('p');
          p.innerHTML = '<br>';
          parentList.parentNode.insertBefore(p, parentList.nextSibling);
          li.remove();
          if (!parentList.children.length) parentList.remove();
          var range = document.createRange();
          range.setStart(p, 0);
          range.collapse(true);
          sel.removeAllRanges();
          sel.addRange(range);
        }
        updateFormatButtons(ce, blockId);
      }

      if (e.key === 'Tab' && li) {
        e.preventDefault();
        var parentList2 = li.parentElement;
        if (e.shiftKey) {
          var grandParentLi = parentList2.parentElement;
          if (grandParentLi && grandParentLi.nodeName === 'LI') {
            grandParentLi.parentElement.insertBefore(li, grandParentLi.nextSibling);
            if (!parentList2.children.length) parentList2.remove();
            setCursorEnd(li);
          }
        } else {
          var prevLi = li.previousElementSibling;
          if (prevLi) {
            var nested = prevLi.querySelector(':scope > ul, :scope > ol');
            if (!nested) {
              nested = makeList(parentList2.nodeName === 'OL' ? 'number'
                : parentList2.classList.contains('list-dash') ? 'dash' : 'bullet');
              prevLi.appendChild(nested);
            }
            nested.appendChild(li);
            setCursorEnd(li);
          }
        }
      }
    }

    function updateFormatButtons(ce, blockId) {
      var block = document.querySelector('[data-id="' + blockId + '"]');
      if (!block) return;
      var sel = window.getSelection();
      var active = null;
      if (sel && sel.rangeCount) {
        var anchor = sel.anchorNode;
        var container = anchor ? (anchor.nodeType === 3 ? anchor.parentElement : anchor) : null;
        var li = container && container.closest && container.closest('li');
        if (li) {
          var pl = li.parentElement;
          active = pl.nodeName === 'OL' ? 'number'
            : pl.classList.contains('list-dash') ? 'dash' : 'bullet';
        }
      }
      block.querySelectorAll('.fmt-btn').forEach(function(btn) {
        btn.classList.toggle('active', btn.dataset.fmt === active);
      });
    }

    // ── Writing ideas ──

    async function loadIdeasFromDB() {
      const { data, error } = await sb.from('topic_ideas').select('*').order('created_at', { ascending: true });
      if (error) { console.error(error); return; }
      ideas = data || [];
    }

    function renderIdeas() {
      const container = document.getElementById('ideaItems');
      if (!ideas.length) {
        container.innerHTML = '';
        return;
      }
      container.innerHTML = ideas.map(function (idea) {
        return '<div class="idea-item">' +
          '<span class="idea-item-text">' + escHtml(idea.text) + '</span>' +
          '<button class="post-item-delete" onclick="deleteIdea(' + idea.id + ')">delete</button>' +
          '</div>';
      }).join('');
    }

    document.getElementById('ideaForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const input = document.getElementById('ideaInput');
      const text = input.value.trim();
      if (!text) return;
      const { data, error } = await sb.from('topic_ideas').insert({ text: text }).select().single();
      if (error) { console.error(error); return; }
      ideas.push(data);
      renderIdeas();
      input.value = '';
      input.focus();
    });

    async function deleteIdea(id) {
      const { error } = await sb.from('topic_ideas').delete().eq('id', id);
      if (error) { console.error(error); return; }
      ideas = ideas.filter(function (i) { return i.id !== id; });
      renderIdeas();
    }

    // ── Helpers ──

    function parseTags(str) {
      return str.split(',').map(function(t) { return t.trim().toLowerCase().replace(/^#+/, ''); }).filter(Boolean);
    }

    function setStatus(msg) {
      document.getElementById('formStatus').textContent = msg;
    }

    function escHtml(str) {
      const d = document.createElement('div');
      d.textContent = String(str);
      return d.innerHTML;
    }

    boot();
  </script>
</body>
</html>
