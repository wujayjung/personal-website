<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wujay Jung</title>
  <link rel="stylesheet" href="style.css?v=2">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <a class="admin-link" href="admin.html" title="">
      <svg width="13" height="13" viewBox="0 0 13 13" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="0.5" y="0.5" width="12" height="12" stroke="currentColor"/>
      </svg>
    </a>

    <header>
      <h1>Wujay Jung</h1>
      <p class="tagline">A student of the startup game.</p>
    </header>

    <main id="feed">
      <p class="empty-state">Nothing here yet.</p>
    </main>
  </div>

  <script>
    const SUPABASE_URL = 'https://zxdqlfusqmhdufsdyhzw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4ZHFsZnVzcW1oZHVmc2R5aHp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MDUyMzksImV4cCI6MjA4NzM4MTIzOX0.qItSdfE15aQcG4D6gYfoJq_2-tfHqd7ltVjV_V7qkZw';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function loadPosts() {
      const { data, error } = await sb.from('posts').select('*').order('created_at', { ascending: false });
      if (error) { console.error(error); return []; }
      return data || [];
    }

    function renderPosts(posts, feed) {
      if (!posts.length) {
        feed.innerHTML = '<p class="empty-state">Nothing here yet.</p>';
        return;
      }

      feed.innerHTML = posts.map(renderPost).join('');
    }

    function renderPost(post) {
      const ts = post.created_at || post.date;
      const date = formatDateTime(ts);
      let body = '';

      if (post.title) {
        body += `<p class="post-title">${escHtml(post.title)}</p>`;
      }

      if (post.blocks && post.blocks.length) {
        body += post.blocks.map(renderBlock).join('');
      }

      return `<article class="post">
  <time class="post-date" datetime="${escHtml(ts)}">${date}</time>
  ${body}
</article>`;
    }

    function renderBlock(block) {
      if (block.type === 'text') {
        return `<p class="post-content post-block">${escHtml(block.content).replace(/\n/g, '<br>')}</p>`;

      } else if (block.type === 'quote') {
        let html = `<blockquote class="post-block">${escHtml(block.content)}</blockquote>`;
        if (block.attribution) {
          const attr = block.url
            ? `<a href="${escHtml(block.url)}" target="_blank" rel="noopener">${escHtml(block.attribution)}</a>`
            : escHtml(block.attribution);
          html += `<p class="post-attribution">— ${attr}</p>`;
        }
        return html;

      } else if (block.type === 'link') {
        const ytId = getYouTubeId(block.url);
        if (ytId) {
          let html = '';
          if (block.description) {
            html += `<p class="post-content post-block">${escHtml(block.description).replace(/\n/g, '<br>')}</p>`;
          }
          html += `<div class="post-embed post-block"><iframe src="https://www.youtube.com/embed/${ytId}" allowfullscreen loading="lazy"></iframe></div>`;
          if (block.title) {
            html += `<p class="post-image-caption">${escHtml(block.title)}</p>`;
          }
          return html;
        }
        let html = '';
        if (block.description) {
          html += `<p class="post-content post-block">${escHtml(block.description).replace(/\n/g, '<br>')}</p>`;
        }
        const label = block.title || block.url;
        html += `<a class="post-link-url post-block" href="${escHtml(block.url)}" target="_blank" rel="noopener">${escHtml(label)}</a>`;
        return html;

      } else if (block.type === 'image') {
        let html = `<figure class="post-image post-block"><img src="${block.src}" alt="${escHtml(block.caption || '')}"></figure>`;
        if (block.caption) {
          html += `<p class="post-image-caption">${escHtml(block.caption)}</p>`;
        }
        return html;
      }

      return '';
    }

    function getYouTubeId(url) {
      const m = url.match(
        /(?:youtube\.com\/(?:watch\?(?:.*&)?v=|embed\/|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/
      );
      return m ? m[1] : null;
    }

    function formatDateTime(iso) {
      const d = new Date(iso);
      const date = d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      const time = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      return `${date} · ${time}`;
    }

    function escHtml(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    const feed = document.getElementById('feed');
    loadPosts().then(function(posts) { renderPosts(posts, feed); });
  </script>
</body>
</html>
