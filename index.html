<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wujay Jung</title>
  <script>document.write('<link rel="stylesheet" href="style.css?v=' + Date.now() + '">');</script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <a class="admin-link" href="admin.html" title="">
      <svg width="13" height="13" viewBox="0 0 13 13" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="0.5" y="0.5" width="12" height="12" stroke="currentColor"/>
      </svg>
    </a>

    <header>
      <h1>Wujay Jung</h1>
      <p class="tagline">A student of the startup game.</p>
    </header>

    <div id="tagFilterBar" style="display:none" class="tag-filter-bar">
      <span id="tagFilterLabel"></span>
      <button onclick="clearTagFilter()">clear</button>
    </div>

    <main id="feed">
      <p class="empty-state">Nothing here yet.</p>
    </main>
  </div>

  <script>
    const SUPABASE_URL = 'https://zxdqlfusqmhdufsdyhzw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4ZHFsZnVzcW1oZHVmc2R5aHp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4MDUyMzksImV4cCI6MjA4NzM4MTIzOX0.qItSdfE15aQcG4D6gYfoJq_2-tfHqd7ltVjV_V7qkZw';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let allPosts = [];
    let isLoggedIn = false;
    let activeTag = null;

    async function boot() {
      const { data: { session } } = await sb.auth.getSession();
      isLoggedIn = !!session;

      let query = sb.from('posts').select('*').order('created_at', { ascending: false });
      if (!isLoggedIn) {
        // Filter at the DB level so private post data is never sent to the browser
        query = query.or('is_private.is.null,is_private.eq.false');
      }

      const { data, error } = await query;
      if (error) { console.error(error); return; }

      allPosts = data || [];

      renderFeed();
    }

    function renderFeed() {
      const feed = document.getElementById('feed');
      let posts = allPosts;

      if (activeTag) {
        posts = posts.filter(function(p) {
          return p.tags && p.tags.includes(activeTag);
        });
        document.getElementById('tagFilterBar').style.display = '';
        document.getElementById('tagFilterLabel').textContent = '#' + activeTag;
      } else {
        document.getElementById('tagFilterBar').style.display = 'none';
      }

      if (!posts.length) {
        feed.innerHTML = activeTag
          ? '<p class="empty-state">No posts tagged #' + escHtml(activeTag) + '.</p>'
          : '<p class="empty-state">Nothing here yet.</p>';
        return;
      }

      feed.innerHTML = posts.map(renderPost).join('');
      loadTwitterWidgets();
    }

    function filterByTag(tag) {
      activeTag = tag;
      renderFeed();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function clearTagFilter() {
      activeTag = null;
      renderFeed();
    }

    function renderPost(post) {
      const ts = post.created_at || post.date;
      const date = formatDateTime(ts);
      const isPrivate = isLoggedIn && post.is_private;
      let body = '';

      if (isPrivate) {
        body += '<span class="private-badge">private</span>';
      }

      if (post.title) {
        body += `<p class="post-title">${escHtml(post.title)}</p>`;
      }

      if (post.blocks && post.blocks.length) {
        body += post.blocks.map(renderBlock).join('');
      }

      if (post.tags && post.tags.length) {
        body += '<div class="post-tags">' +
          post.tags.map(function(tag) {
            return '<button class="tag" onclick="filterByTag(\'' + escHtml(tag) + '\')">#' + escHtml(tag) + '</button>';
          }).join('') +
          '</div>';
      }

      const cls = isPrivate ? 'post post--private' : 'post';
      return `<article class="${cls}">
  <time class="post-date" datetime="${escHtml(ts)}">${date}</time>
  ${body}
</article>`;
    }

    // ── Text content renderer (handles plain text + bullet/dash/numbered lists) ──

    function getLineListInfo(line) {
      const t = line.trimStart();
      if (!t) return null;
      const level = Math.floor((line.length - t.length) / 2);
      if (t.startsWith('• '))                        return { tag: 'ul', cls: '',          content: t.slice(2),            level };
      if (t.startsWith('- ') && t.length > 2)        return { tag: 'ul', cls: 'list-dash', content: t.slice(2),            level };
      const m = t.match(/^\d+\. ([\s\S]*)/);
      if (m)                                          return { tag: 'ol', cls: '',          content: m[1],                  level };
      return null;
    }

    function renderNestedList(items, base) {
      const first = items.find(function(it) { return it.level === base; });
      if (!first) return '';
      const open = '<' + first.tag + (first.cls ? ' class="' + first.cls + '"' : '') + '>';
      const close = '</' + first.tag + '>';
      let html = open;
      let j = 0;
      while (j < items.length) {
        const item = items[j];
        if (item.level !== base) { j++; continue; }
        const nested = [];
        let k = j + 1;
        while (k < items.length && items[k].level > base) { nested.push(items[k]); k++; }
        html += '<li>' + escHtml(item.content) + (nested.length ? renderNestedList(nested, base + 1) : '') + '</li>';
        j = k;
      }
      return html + close;
    }

    function renderTextContent(raw) {
      if (!raw) return '';
      const lines = raw.split('\n');
      const segs = [];
      let textBuf = [];

      function flushText() {
        if (!textBuf.length) return;
        segs.push({ type: 'text', content: textBuf.join('\n') });
        textBuf = [];
      }

      let i = 0;
      while (i < lines.length) {
        const line = lines[i];
        const info = getLineListInfo(line);
        if (info) {
          flushText();
          const items = [];
          while (i < lines.length) {
            const li = getLineListInfo(lines[i]);
            if (li) { items.push(li); i++; }
            else if (!lines[i].trim()) { i++; break; }
            else break;
          }
          if (items.length) {
            const minLv = Math.min.apply(null, items.map(function(it) { return it.level; }));
            segs.push({ type: 'list', items: items.map(function(it) { return Object.assign({}, it, { level: it.level - minLv }); }) });
          }
        } else if (!line.trim()) {
          flushText();
          i++;
        } else {
          textBuf.push(line);
          i++;
        }
      }
      flushText();

      return segs.map(function(seg) {
        if (seg.type === 'list') return renderNestedList(seg.items, 0);
        return '<p>' + escHtml(seg.content).replace(/\n/g, '<br>') + '</p>';
      }).join('');
    }

    function renderBlock(block) {
      if (block.type === 'text') {
        return '<div class="post-content post-block">' + renderTextContent(block.content) + '</div>';

      } else if (block.type === 'quote') {
        let html = `<blockquote class="post-block">${escHtml(block.content)}</blockquote>`;
        if (block.attribution) {
          const attr = block.url
            ? `<a href="${escHtml(block.url)}" target="_blank" rel="noopener">${escHtml(block.attribution)}</a>`
            : escHtml(block.attribution);
          html += `<p class="post-attribution">— ${attr}</p>`;
        }
        return html;

      } else if (block.type === 'link') {
        const ytId = getYouTubeId(block.url);
        if (ytId) {
          let html = '';
          if (block.description) {
            html += `<p class="post-content post-block">${escHtml(block.description).replace(/\n/g, '<br>')}</p>`;
          }
          html += `<div class="post-embed post-block"><iframe src="https://www.youtube.com/embed/${ytId}" allowfullscreen loading="lazy"></iframe></div>`;
          if (block.title) {
            html += `<p class="post-image-caption">${escHtml(block.title)}</p>`;
          }
          return html;
        }
        const tweetUrl = getTwitterTweetUrl(block.url);
        if (tweetUrl) {
          let html = '';
          if (block.description) {
            html += `<p class="post-content post-block">${escHtml(block.description).replace(/\n/g, '<br>')}</p>`;
          }
          html += `<div class="post-tweet post-block"><blockquote class="twitter-tweet" data-dnt="true"><a href="${escHtml(tweetUrl)}">${escHtml(tweetUrl)}</a></blockquote></div>`;
          return html;
        }
        let html = '';
        if (block.description) {
          html += `<p class="post-content post-block">${escHtml(block.description).replace(/\n/g, '<br>')}</p>`;
        }
        const label = block.title || block.url;
        html += `<a class="post-link-url post-block" href="${escHtml(block.url)}" target="_blank" rel="noopener">${escHtml(label)}</a>`;
        return html;

      } else if (block.type === 'image') {
        let html = `<figure class="post-image post-block"><img src="${block.src}" alt="${escHtml(block.caption || '')}"></figure>`;
        if (block.caption) {
          html += `<p class="post-image-caption">${escHtml(block.caption)}</p>`;
        }
        return html;
      }

      return '';
    }

    function getYouTubeId(url) {
      const m = url.match(
        /(?:youtube\.com\/(?:watch\?(?:.*&)?v=|embed\/|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/
      );
      return m ? m[1] : null;
    }

    function getTwitterTweetUrl(url) {
      const m = url.match(/(?:twitter\.com|x\.com)\/\w+\/status\/\d+/);
      return m ? 'https://' + m[0] : null;
    }

    let twitterScriptLoaded = false;
    function loadTwitterWidgets() {
      if (window.twttr && window.twttr.widgets && window.twttr.widgets.load) {
        window.twttr.widgets.load();
      } else if (!twitterScriptLoaded) {
        twitterScriptLoaded = true;
        const s = document.createElement('script');
        s.src = 'https://platform.twitter.com/widgets.js';
        s.async = true;
        document.head.appendChild(s);
      }
    }

    function formatDateTime(iso) {
      const d = new Date(iso);
      const date = d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      const time = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
      return `${date} · ${time}`;
    }

    function escHtml(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    boot();
  </script>
</body>
</html>
